# pyOCD debugger
# Copyright (c) 2017-2018 Arm Limited
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from ..family.target_kinetis import Kinetis
from ..family.flash_kinetis import Flash_Kinetis
from ...core.memory_map import (FlashRegion, RamRegion, MemoryMap)
from ...debug.svd.loader import SVDFile

FLASH_ALGO = {
    'load_address' : 0x20000000,

    # Flash algorithm as a hex string
    'instructions': [
    0xe7fdbe00,
    0x4605b570, 0x4616460c, 0xcc0fe002, 0x3e10c50f, 0xd2fa2e10, 0xd3022e08, 0xc503cc03, 0x2e043e08,
    0xcc01d307, 0x1f36c501, 0x7821e003, 0x1c647029, 0x1e761c6d, 0xbd70d2f9, 0x4827b510, 0x220568c1,
    0x43110352, 0xbf0060c1, 0x49242000, 0x48246008, 0x444821ff, 0x70417001, 0x70c17081, 0x710222fe,
    0x71817141, 0x481f71c1, 0xf0004448, 0x2800f949, 0x2001d000, 0x2000bd10, 0x481a4770, 0x491ab510,
    0xf0004448, 0x2800f983, 0x4a15d10a, 0x21814815, 0x444a2308, 0x444800c9, 0xfa07f000, 0xd0002800,
    0xbd102001, 0x480f4601, 0x2201b510, 0x02d24b0e, 0xf0004448, 0x2800f9a7, 0x2001d000, 0x1dc9bd10,
    0x460108cb, 0xb5104807, 0x444800db, 0xf9edf000, 0xd0002800, 0xbd102001, 0xf0003000, 0x40048100,
    0x00000004, 0x0000000c, 0x6b65666b, 0x217048f9, 0x21807001, 0x78017001, 0xd5fc0609, 0x06817800,
    0x2067d501, 0x06c14770, 0x2068d501, 0x07c04770, 0x2069d0fc, 0xb5f84770, 0x0005460e, 0xd0134614,
    0x46102120, 0xfe3ef000, 0x27086aa8, 0xd80d42b0, 0x18416ae9, 0xd30942b1, 0x05391a30, 0x60201840,
    0x60601308, 0xe00a6ae8, 0xbdf82004, 0x1a306828, 0x68e86020, 0x7a296060, 0xf0006868, 0x60e7fe36,
    0x61676127, 0x60a061a7, 0x61e02004, 0xbdf82000, 0xb089b5ff, 0x9f129809, 0x4614461d, 0x2800460e,
    0x2c00d00d, 0x466ad00b, 0xffc5f7ff, 0x46399806, 0x42061e40, 0x4205d101, 0x2065d004, 0x2004e01a,
    0xbdf0b00d, 0x20001972, 0x29011e52, 0x2f00d002, 0xe003d006, 0xd1012e08, 0xd00b2d08, 0xe0092004,
    0x02892101, 0xd305428a, 0x429e034b, 0x49c2d3f6, 0xd8f3428a, 0x4ac10639, 0x18894fbe, 0x28009108,
    0xe01fd1de, 0x21030230, 0x06090a00, 0x60781840, 0x28049806, 0x2808d002, 0xe004d003, 0x60f89808,
    0x9808e001, 0x980960b8, 0xff70f7ff, 0xd1c72800, 0xc40268b9, 0x29089906, 0x68f9d101, 0x9906c402,
    0x1a6d198e, 0xd1dd2d00, 0xb5fee7ba, 0xd00b0004, 0x250049a9, 0xaa012308, 0x95001fc9, 0xff98f7ff,
    0xd0032800, 0xbdfe206e, 0xbdfe2004, 0x7a404668, 0x0f090701, 0x72414668, 0x000b48a1, 0xfe62f000,
    0x0e0b0910, 0x1a171411, 0x09211f1d, 0x09090909, 0x63200923, 0x2001e018, 0xe7fa0340, 0x03002001,
    0x2001e7f7, 0xe7f402c0, 0x02802001, 0x2001e7f1, 0xe7ee0240, 0x300120ff, 0x2080e7eb, 0x2040e7e9,
    0x2020e7e7, 0x6325e7e5, 0x7a004668, 0x07012201, 0x46680f09, 0x04927201, 0x43c02000, 0x000b1056,
    0xfe30f000, 0x0b0b0910, 0x1513100d, 0x0b0b150b, 0x09131b18, 0x62e20b09, 0x62e0e00a, 0x2007e008,
    0xe7fa03c0, 0x04002003, 0x62e6e7f7, 0x62e5e000, 0xbdfe2000, 0x03c02001, 0x2001e7ef, 0xe7ec0400,
    0x2800b430, 0x4977d024, 0x010968c9, 0x290f0f09, 0x4a75d021, 0x447a0049, 0x02895a51, 0x60032300,
    0x21016041, 0x02c97201, 0x496a60c1, 0x7a0c3120, 0x40a2158a, 0x7ac96142, 0x61816103, 0x06892105,
    0x21016201, 0x62410349, 0x628103c9, 0xe76cbc30, 0x2004bc30, 0x21014770, 0xe7df0489, 0xd0022800,
    0x20006101, 0x20044770, 0x48604770, 0x22016801, 0x43110292, 0xf3bf6001, 0xf3bf8f6f, 0x47708f4f,
    0x4603b500, 0xf7ff4618, 0xbd00fff0, 0x0005b570, 0x4a50d011, 0x60504856, 0xf0004608, 0x2800fcd7,
    0x4628d10a, 0xfea2f7ff, 0x46284604, 0xffe8f7ff, 0xd0022c00, 0x2004e005, 0x4628bd70, 0xff35f7ff,
    0x46204604, 0xb510bd70, 0xd0062800, 0x42191e5b, 0x421ad101, 0x2065d003, 0x2004bd10, 0x6a83bd10,
    0x428b188a, 0x6ac4d803, 0x4293191b, 0x6803d206, 0xd805428b, 0x18186840, 0xd3014290, 0xbd102000,
    0xbd102066, 0xb089b5ff, 0x460c4616, 0x9809466a, 0xfe81f7ff, 0x46214632, 0x98099b04, 0xffd3f7ff,
    0xd12b0005, 0x9f019c00, 0x1e7619a6, 0x46304639, 0xfccbf000, 0xd01b2900, 0x43781c40, 0xe0171e46,
    0x20090221, 0x06000a09, 0x48221809, 0x980c6041, 0xfc7cf000, 0xd1112800, 0xf7ff9809, 0x4605fe47,
    0x69009809, 0xd0002800, 0x2d004780, 0x19e4d102, 0xd9e542b4, 0xf7ff9809, 0x4628ff83, 0xb570e690,
    0xd0100004, 0x481b4a13, 0x46086050, 0xfc5ef000, 0xd1072800, 0xf7ff4620, 0x4605fe29, 0xf7ff4620,
    0x4628ff6f, 0x2004bd70, 0xb5ffbd70, 0x461fb089, 0x460d0014, 0x466ad020, 0xf7ff9809, 0x463afe2c,
    0x9b034629, 0xf7ff9809, 0x0006ff7e, 0x9d00d115, 0x0000e03a, 0x40020000, 0x008003ff, 0x00ffffff,
    0x0000ffff, 0x40048040, 0x00000c2e, 0xf000300c, 0x44ffffff, 0x4bffffff, 0xe6512004, 0x48facc02,
    0x99036081, 0xd0022904, 0xd0072908, 0x0229e00e, 0x0a092203, 0x18890652, 0xe0076041, 0x60c1cc02,
    0x22070229, 0x06120a09, 0x60411889, 0xf7ff9809, 0x4606fddd, 0x69009809, 0xd0002800, 0x2e004780,
    0x9803d104, 0x1a3f1945, 0xd1d72f00, 0xf7ff9809, 0x4630ff17, 0xb570e624, 0xd0140004, 0xd0122a00,
    0x49e20608, 0x18400a00, 0x604849df, 0x60886810, 0x60c86850, 0xf7ff4620, 0x4605fdb9, 0xf7ff4620,
    0x4628feff, 0x2004bd70, 0xb510bd70, 0xd0050002, 0xd00529ff, 0xd0032900, 0xe0022004, 0xbd102004,
    0x28002000, 0x0408d1fb, 0x184049d1, 0x604849ce, 0xf7ff4610, 0xbd10fd9b, 0xb08bb5ff, 0x90092000,
    0x460c980d, 0xd01f2800, 0x980baa01, 0xfda3f7ff, 0x9b064621, 0x980b9a0e, 0xfef5f7ff, 0x28009000,
    0x9802d110, 0x48c0900a, 0x78409e01, 0xd45b0780, 0x90092001, 0x980b21ff, 0xffc7f7ff, 0x28009000,
    0x2071d052, 0xbdf0b00f, 0xe7fb2004, 0x4270990a, 0x40084249, 0x24004240, 0xd10142b0, 0x1840990a,
    0x1989990e, 0xd9014281, 0xe0321b85, 0xe0309d0e, 0x02bf2701, 0xd80042bd, 0x08a1462f, 0x0089980d,
    0x20051809, 0x0680463a, 0xfcdaf7ff, 0x02001930, 0x0a00210b, 0x18410609, 0x604148a3, 0x99064638,
    0xfbb3f000, 0x040049a3, 0x489f1841, 0x980b6081, 0xfd3cf7ff, 0x980b9000, 0x28006900, 0x4780d000,
    0x28009800, 0x980bd003, 0xfe7af7ff, 0x1bede01e, 0x2d0019e4, 0x08a1d1cc, 0x0089980d, 0x900d1808,
    0x1936980e, 0x900e1b00, 0x2800980e, 0x980bd1ae, 0xfe66f7ff, 0x28009809, 0x2100d008, 0xf7ff980b,
    0x9000ff64, 0xd0012800, 0xe79b2072, 0xe7999800, 0x4607b5f8, 0x461d2000, 0x460c4616, 0x2f009000,
    0x6a38d009, 0xd80442a0, 0x18406b39, 0x42881961, 0x2066d203, 0x2004bdf8, 0x497bbdf8, 0x78492000,
    0xd12807c9, 0x90002001, 0xf7ff4638, 0x2800ff3e, 0x206fd021, 0x07a1bdf8, 0x2d04d105, 0xce02d303,
    0xc4021f2d, 0x07e1e00e, 0x2d02d107, 0x8831d305, 0x1ca48021, 0x1cb61ead, 0x7831e004, 0x1c647021,
    0x1c761e6d, 0x784a4968, 0xd0fc07d2, 0x06c97809, 0x2068d501, 0x2d00bdf8, 0x9900d1dd, 0xd0f92900,
    0x463821ff, 0xff11f7ff, 0xd0f32800, 0xbdf82070, 0x4614b570, 0xd0102800, 0xd00e2c00, 0x4a5e0609,
    0x4d590a09, 0x60691889, 0xfcb0f7ff, 0xd1032800, 0x602168a9, 0x606168e9, 0x2004bd70, 0x2800bd70,
    0x2900d00e, 0x4850d00c, 0x07827880, 0x2a020f92, 0x0980d008, 0xd0072802, 0x70082002, 0x47702000,
    0x47702004, 0xe7f82000, 0xe7f62001, 0x460cb570, 0xd0200006, 0xd01e2c00, 0x20004d43, 0x078978a9,
    0x29020f89, 0x4845d016, 0x46206068, 0xfadcf000, 0x0a00ba00, 0x020078e1, 0x60a84308, 0xf0001d20,
    0xba00fad3, 0x79e10a00, 0x43080200, 0x463060e8, 0xfc6cf7ff, 0x2004bd70, 0xb510bd70, 0xd0072800,
    0x04094a37, 0x4a301889, 0xf7ff6051, 0xbd10fc5f, 0xbd102004, 0xb089b5ff, 0x460d4614, 0x9809466a,
    0xfc69f7ff, 0x46294622, 0x98099b05, 0xfdbbf7ff, 0xd12f2800, 0x4629466a, 0xf7ff9809, 0x9d00fc5c,
    0x90089802, 0x42404269, 0x424f4001, 0xd10142af, 0x183f9808, 0xd01c2c00, 0x42a61b7e, 0x4626d900,
    0x99054630, 0xfaa1f000, 0x22010229, 0x06120a09, 0x4915188a, 0x9a0c604a, 0x02120400, 0x30ff4310,
    0x98096088, 0xfc22f7ff, 0xd1032800, 0x19ad1ba4, 0x2000e7de, 0xb5ffe474, 0x9f12b089, 0x4616001d,
    0xd021460c, 0x9809466a, 0xfc25f7ff, 0x46214632, 0x98099b07, 0xfd77f7ff, 0xd1162800, 0x06394a09,
    0x9c00188f, 0x0000e032, 0x40020000, 0x4300ffff, 0x8100ffff, 0x0000ffff, 0x4100ffff, 0x45ffffff,
    0x4000ffff, 0x00ffffff, 0xe4492004, 0x20010221, 0x06400a09, 0x48fb1809, 0x60876041, 0x60c16829,
    0xf7ff9809, 0x2800fbe3, 0x9913d009, 0xd0002900, 0x9914600c, 0xd0e82900, 0x600a2200, 0x9907e430,
    0x08891a76, 0x194d0089, 0x190c9907, 0xd1dd2e00, 0xb510e426, 0xd0072800, 0x04094aeb, 0x4ae91889,
    0xf7ff6051, 0xbd10fbc3, 0xbd102004, 0xb0adb5f0, 0x4616001d, 0x4607460c, 0x2308d013, 0xfd23f7ff,
    0xd10f2800, 0xd00f2f00, 0x90019000, 0x683a9002, 0x92006879, 0x92022220, 0x42910292, 0x0949d906,
    0x2004e006, 0xbdf0b02d, 0xe0022004, 0x02892101, 0x28009101, 0x19a1d1f6, 0x2100468c, 0x9a01e007,
    0x434a9b00, 0x008e189b, 0x5193aa03, 0x9a021c49, 0xd2f4428a, 0x49cb2200, 0xe01cae24, 0xd2042a08,
    0x40d37c0b, 0x0fdb07db, 0x4613e013, 0x2b083b08, 0x7c4fd201, 0x4613e00a, 0x2b083b10, 0x7c8fd201,
    0x4613e004, 0x2b083b18, 0x7ccfd208, 0x07fb40df, 0x54b30fdb, 0x9b021c52, 0xd8df4293, 0x460b2100,
    0xe012460a, 0xaf03008e, 0x42a759bf, 0xaf03d80c, 0x687619f6, 0xd90742a6, 0x5c76ae24, 0x2e001c5b,
    0x1c52d100, 0x19349e01, 0x45641c49, 0x2a00d3ea, 0x429ad003, 0x2101d103, 0x2100e002, 0x2102e000,
    0xe79f7029, 0xb085b5f0, 0x4617001e, 0x4605460c, 0x2308d022, 0xfca7f7ff, 0xd11e2800, 0xd01e2d00,
    0x90019000, 0x68289002, 0x69689000, 0x69a89001, 0x20009002, 0x28009003, 0x9801d10f, 0x424019e7,
    0x42794602, 0x40224008, 0x25001880, 0x99014240, 0xf98bf000, 0xe01b9004, 0xb0052004, 0x2004bdf0,
    0x9800e7e8, 0x1a209901, 0xf97ff000, 0xd2022820, 0x69c9498c, 0x9902e005, 0xd90b4281, 0x69894989,
    0x22013820, 0x438a4082, 0x1c6dd000, 0x19049801, 0xd3e642bc, 0xd0042d00, 0x42859804, 0x2002d203,
    0x2000e002, 0x2001e000, 0x98037030, 0xb510e7d5, 0xd0112800, 0xd00f2a00, 0x000b2401, 0xfa02f000,
    0x11110e16, 0x1a171513, 0x2e201e1c, 0x2e2e2e2e, 0x2725222e, 0x2e2c2a17, 0xbd102004, 0x601068c0,
    0x6840e006, 0x7a00e7fb, 0x6800e7f9, 0x6014e7f7, 0xbd102000, 0xe7f26940, 0xe7f06980, 0xe7ee6a00,
    0xe7ec6a40, 0x02c02001, 0x6ac0e7e9, 0x2001e7e7, 0xe7e40480, 0xe7e26a80, 0xe7e06b00, 0xbd10206a,
    0x4604b510, 0x2c002000, 0x000bd014, 0xf9caf000, 0x1c1c1c22, 0x1c1c1c1c, 0x1e1c1c1c, 0x1e1e1e1e,
    0x1c1c1c1e, 0x1e1c1c1c, 0x1e1e1e1e, 0x1e1e1e1e, 0x1e141e1e, 0xbd102004, 0xd0032a00, 0xd0012a01,
    0xbd102077, 0xbd1072a2, 0xbd102076, 0xbd10206a, 0x0004b570, 0x484dd017, 0x484a1809, 0x06116041,
    0x0a12061a, 0x43114d4a, 0x60811949, 0xf7ff4620, 0x4606fa7d, 0xf7ff4620, 0x2000fbc3, 0x632543c0,
    0x463062e0, 0x2004bd70, 0x2800bd70, 0x483dd008, 0x6102680a, 0x69006809, 0xd0034281, 0x47702069,
    0x47702004, 0x47702000, 0xd0062800, 0xd0042900, 0x69004834, 0x20006008, 0x20044770, 0x28004770,
    0x6ac0d00b, 0xd00a2800, 0xd0081c40, 0x75c1482d, 0x42887dc0, 0x2069d005, 0x20044770, 0x20734770,
    0x20004770, 0x28004770, 0x2900d00b, 0x6ac0d009, 0xd0082800, 0xd0061c40, 0x7dc04822, 0x20007008,
    0x20044770, 0x20734770, 0x28004770, 0x6b00d007, 0xd0022800, 0x42904a1e, 0x2073d103, 0x20044770,
    0x48184770, 0x7d807581, 0xd0014288, 0x47702069, 0x47702000, 0xd0092800, 0xd0072900, 0x28006b00,
    0x4a13d002, 0xd1034290, 0x47702073, 0x47702004, 0x7d80480c, 0x20007008, 0x23004770, 0x220156c3,
    0x03d2490c, 0xd0171c5b, 0x4393680b, 0x7842600b, 0x03802001, 0x680a2a00, 0x4382d017, 0x2000600a,
    0x00004770, 0x40020000, 0x4a00ffff, 0x80ffff00, 0x0000ffff, 0xf000300c, 0x28007840, 0x6808d003,
    0x60084310, 0x2078e7eb, 0x4302e7ea, 0x2100e7e6, 0x70417001, 0x68c94909, 0x040b4a09, 0x7002d501,
    0x0449e001, 0x7042d400, 0xe7d92000, 0x42884905, 0x206bd001, 0x2000e7d4, 0x0000e7d2, 0xf0003000,
    0xffffffff, 0x6b65666b, 0xc004e001, 0x29041f09, 0x078bd2fb, 0x8002d501, 0x07c91c80, 0x7002d000,
    0x29004770, 0x07c3d00b, 0x7002d002, 0x1e491c40, 0xd3042902, 0xd5020783, 0x1c808002, 0xe7e31e89,
    0xe7ee2200, 0xe7df2200, 0x78c27803, 0x78434619, 0x021b0612, 0x78834319, 0x041b78c0, 0x43114319,
    0x0a090209, 0x43080600, 0x22004770, 0x428b0903, 0x0a03d32c, 0xd311428b, 0x469c2300, 0x4603e04e,
    0xd43c430b, 0x08432200, 0xd331428b, 0x428b0903, 0x0a03d31c, 0xd301428b, 0xe03f4694, 0x428b09c3,
    0x01cbd301, 0x41521ac0, 0x428b0983, 0x018bd301, 0x41521ac0, 0x428b0943, 0x014bd301, 0x41521ac0,
    0x428b0903, 0x010bd301, 0x41521ac0, 0x428b08c3, 0x00cbd301, 0x41521ac0, 0x428b0883, 0x008bd301,
    0x41521ac0, 0x428b0843, 0x004bd301, 0x41521ac0, 0xd2001a41, 0x41524601, 0x47704610, 0x0fcae05d,
    0x4249d000, 0xd3001003, 0x40534240, 0x469c2200, 0x428b0903, 0x0a03d32d, 0xd312428b, 0x018922fc,
    0x0a03ba12, 0xd30c428b, 0x11920189, 0xd308428b, 0x11920189, 0xd304428b, 0xd03a0189, 0xe0001192,
    0x09c30989, 0xd301428b, 0x1ac001cb, 0x09834152, 0xd301428b, 0x1ac0018b, 0x09434152, 0xd301428b,
    0x1ac0014b, 0x09034152, 0xd301428b, 0x1ac0010b, 0x08c34152, 0xd301428b, 0x1ac000cb, 0x08834152,
    0xd301428b, 0x1ac0008b, 0xd2d94152, 0x428b0843, 0x004bd301, 0x41521ac0, 0xd2001a41, 0x46634601,
    0x105b4152, 0xd3014610, 0x2b004240, 0x4249d500, 0x46634770, 0xd300105b, 0xb5014240, 0x46c02000,
    0xbd0246c0, 0x4674b430, 0x78251e64, 0x42ab1c64, 0x461dd200, 0x005b5d63, 0xbc3018e3, 0x00004718,
    0x40020004, 0x40020010, 0x00100008, 0x00200018, 0x00400030, 0x00800060, 0x010000c0, 0x02000180,
    0x04000300, 0x00000600, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000
    ],

    # Relative function addresses
    'pc_init': 0x2000003d,
    'pc_unInit': 0x2000007b,
    'pc_program_page': 0x200000c3,
    'pc_erase_sector': 0x200000a9,
    'pc_eraseAll': 0x2000007f,

    'static_base' : 0x20000000 + 0x00000004 + 0x00000f68,
    'begin_stack' : 0x200023b0,
    'end_stack' : 0x200013b0,
    'begin_data' : 0x20000000 + 0x1000,
    'page_size' : 0x200,
    'analyzer_supported' : False,
    'analyzer_address' : 0x00000000,
    # Enable double buffering
    'page_buffers' : [
        0x20000fb0,
        0x200011b0
    ],
    'min_program_length' : 0x200,

    # Relative region addresses and sizes
    'ro_start': 0x4,
    'ro_size': 0xf68,
    'rw_start': 0xf6c,
    'rw_size': 0xc,
    'zi_start': 0xf78,
    'zi_size': 0x34,

    # Flash information
    'flash_start': 0x10000000,
    'flash_size': 0x40000,
    'sector_sizes': (
        (0x0, 0x800),
    )
}


class KW38A4(Kinetis):

    MEMORY_MAP = MemoryMap(
        FlashRegion(
            name="flash",
            start=0x00000000,
            length=0x00080000,    # 512 KB Flash
            blocksize=0x1000,     # 4 KB erase sector
            is_boot_memory=True,
            algo=FLASH_ALGO,
            flash_class=Flash_Kinetis
        ),
        RamRegion(
            name="sram",
            start=0x20000000,
            length=0x00008000     # 32 KB SRAM
        ),
        RamRegion(
            name="flexram",
            start=0x14000000,
            length=0x00002000
        ),
    )

    def __init__(self, session):
        super(KW38A4, self).__init__(session, self.MEMORY_MAP)
        self._svd_location = SVDFile.from_builtin("MKW38A4.svd")
